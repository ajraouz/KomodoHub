<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register to Komodo Hub</title>
    <link rel="stylesheet" href="/Web Pages/LoginRegister.css" type="text/css">
    <link rel="stylesheet" href="/Web Pages/Popup.css">
</head>
<body>
    <a href="#" id="home">
        <img src="/Web Pages/Images/komodoLogo.png" alt="Logo" class="logo">
    </a>
    <div class="form-container register-box">
        <h2 class="form-title">Register to Komodo Hub</h2>
        <form id="registerForm" action="/register" method="POST">
            <input type="text" name="name" placeholder="Name *" required>
            <input type="text" name="username" placeholder="Username *" required>

            <div class="password-container">
                <input type="password" id="password" name="password" placeholder="Password *" required>
                <button type="button" class="toggle-password" onclick="togglePassword('password', this)">ðŸ‘“</button>
            </div>
            
            <div class="password-container">
                <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm password *" required>
                <button type="button" class="toggle-password" onclick="togglePassword('confirm_password', this)">ðŸ‘“</button>
            </div>

            <div class="dropdown">
                <select name="user_type" id="dropdown" required>
                    <option value="" disabled selected hidden>Register as :</option>
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                    <option value="member">Member</option>
                </select>
            </div>
    
            <input id="accessCode" name="access_code" type="text" placeholder="Access code" required>

            <img src="/Web Pages/Images/giphy.gif" alt="Loading animation" class="gif">

            <button id="submit" type="submit" class="submit-button">Register</button>

        </form>
        <p class="redirect">
            Already have an account? <a href="#" id="loginLink">Login</a>
        </p>
    </div>

    <script>
        document.getElementById('dropdown').addEventListener('change', function () {
            let selectedValue = this.value;
            let accessCodeInput = document.getElementById('accessCode');
            let button = document.getElementById('submit');

            // Show/hide access code field based on selection
            if (selectedValue === 'student' || selectedValue === 'teacher') {
                accessCodeInput.style.display = 'block';
                accessCodeInput.required = true;
                button.textContent = 'Register';
            }
            else if (selectedValue === 'member') {
                accessCodeInput.style.display = 'none';
                accessCodeInput.required = false;
                button.textContent = 'Go to Payment Page';
            }
            else {
                accessCodeInput.style.display = 'none';
                accessCodeInput.required = false;
            }
        });

        document.querySelector('input[name="username"]').addEventListener('input', function () {
            let username = this.value.trim(); // Get entered username
            let dropdown = document.getElementById('dropdown');
            let accessCodeInput = document.getElementById('accessCode');
            let dropdownContainer = dropdown.parentElement; // Get the dropdown wrapper div

            // Define the specific username that triggers the hide behavior
            let specialUsername = "KhairunnisaUjungRayaPrimary"; // Change this to the username you want
            let specialUsername2 = "AdminUser#404";

            if (username === specialUsername || username === specialUsername2) {
                dropdownContainer.classList.add('hidden'); // Hide the dropdown
                dropdown.removeAttribute('required'); // Remove required attribute
                dropdown.value = ""; // Clear its value
                accessCodeInput.classList.add('hidden');  // Hide access code input
                accessCodeInput.removeAttribute('required');
            } else {
                dropdownContainer.classList.remove('hidden');
                dropdown.setAttribute('required', 'true'); // Ensure required is added back
                accessCodeInput.classList.remove('hidden');
                accessCodeInput.setAttribute('required', 'true');
            }
        });



        document.getElementById('registerForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            let name = document.querySelector('input[placeholder="Name *"]').value;
            let username = document.querySelector('input[placeholder="Username *"]').value;
            let password = document.querySelector('input[placeholder="Password *"]').value;
            let confirmPassword = document.querySelector('input[placeholder="Confirm password *"]').value;
            let userType = document.getElementById('dropdown').value;
            let accessCode = document.getElementById('accessCode').value;
            
            // Set userType to "admin" if username is "adminUser"
            if (username === "KhairunnisaUjungRayaPrimary") {
                userType = "principal";
            }
            if (username === "AdminUser#404") {
                userType = "admin";
            }

            if (password !== confirmPassword) {
                showPopup("Passwords do not match!", "error", 1500);
                return;
            }

            // Prepare user data for registration
            let formData = new FormData();
            formData.append('name', name);
            formData.append('username', username);
            formData.append('password', password);
            formData.append('user_type', userType);

            // If user is a member, store the data in localStorage and redirect to payment page
            if (userType === 'member') {
                localStorage.setItem('registrationData', JSON.stringify({
                    name: name,
                    username: username,
                    password: password,
                    userType: userType
                }));
                
                // Redirect to payment page
                window.location.replace('/Web Pages/PaymentPage.html');
            }

            else if (userType === 'student' || userType === 'teacher') {
                // Students and teachers require an access code
                if (!accessCode) {
                    showPopup("Access code is required!", "error", 1500);
                    return;
                }
                formData.append('access_code', accessCode);
            }
            // Handle student or teacher registration immediately
            fetch('/register', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                let result = await response.json(); // Parse JSON correctly
                if (response.ok) {
                    showPopup("WELCOME ðŸ¤©", "success", 1500);  // Call function to show animated pop-up
                    setTimeout(() => {
                        window.location.replace('/Web Pages/LoginPage.html');
                    }, 1700);  // Redirect to login page
                } else {
                    showPopup("" + result.error, "error", 2200);
                }
            })
            .catch(error => {
                showPopup("An error occurred while logging in.", "error", 2200);
            });
        });

        function togglePassword(fieldId, button) {
            let passwordField = document.getElementById(fieldId);
            if (passwordField.type === "password") {
                passwordField.type = "text";
                button.textContent = "ðŸ‘€"; // Hands off eyes
            } else {
                passwordField.type = "password";
                button.textContent = "ðŸ‘“"; // Hands covering eyes
            }
        }

        function showPopup(message, type, time) {
            let popup = document.createElement("div");
            popup.classList.add("popup", type);
            popup.textContent = message;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.classList.add("show");
            }, 10);
            
            setTimeout(() => {
                popup.classList.remove("show");
                setTimeout(() => popup.remove(), 500);
            }, time);
        }
        document.getElementById("loginLink").addEventListener("click", function (event) {
            event.preventDefault(); // Prevent default navigation
            window.location.replace("/Web Pages/LoginPage.html"); // Redirect without allowing back navigation
        });
        document.getElementById("home").addEventListener("click", function (event) {
            event.preventDefault(); // Prevent default navigation
            window.location.replace("/Web Pages/HomePage.html"); // Redirect without allowing back navigation
        });
    </script>
</body>
</html>

